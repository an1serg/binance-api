name: certbot

services:

  nginx:
    container_name: certbot-nginx
    build:
      context: ..
      dockerfile: prod/Dockerfile.nginx
    ports:
      - 80:80
      - 443:443

    volumes:
      - ../prod/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../prod/nginx/mime.types:/etc/nginx/mime.types:ro
      - ../prod/nginx/gzip.conf:/etc/nginx/gzip.conf:ro
      - ../prod/nginx/conf.d/server-80.conf:/etc/nginx/conf.d/server-80.conf:ro

      - ../certbot/www/:/var/www/certbot/:ro
      - ../certbot/conf/:/etc/nginx/ssl/:ro
      # - ../certbot/conf/live/btlz-api.ru/fullchain.pem:/etc/nginx/ssl/live/btlz-api.ru/fullchain.pem:ro
      # - ../certbot/conf/live/btlz-api.ru/privkey.pem:/etc/nginx/ssl/live/btlz-api.ru/privkey.pem:ro

    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 5

    restart: unless-stopped
    
  certbot:
    container_name: certbot
    image: certbot/certbot:latest
    volumes:
      - ../certbot/www/:/var/www/certbot/:rw
      - ../certbot/conf/:/etc/letsencrypt/:rw
    entrypoint: "/bin/sh -c 'certbot certonly --webroot --webroot-path /var/www/certbot/ -d btlz-api.ru -d www.btlz-api.ru -v -n'"

